---
layout: post
tags: [network] # add tag
img: internet.jpg
---

# DHCP

一台主机要接入因特网，需要配置 IP 地址、子网掩码、默认网关和域名服务器。动态主机配置协议(DHCP)提供了分配的服务

DHCP 的分配方式是：网络中至少有一台 DHCP 服务器在工作，它会通过端口 67 监听网络的 DHCP 请求，并与客户端协商配置客户机的 TCP/IP 环境

DHCP 协议使用 UDP 作为运输层协议，DHCP 服务器端口号是 67，客户端的端口号是 68.DHCP 服务器管理一个或多个 IP 地址域，称为地址池。当收到客户端的请求后，会从地址池中取出一个未用的地址分配给客户端，称为出租。

## DHCP 的原理

> DHCP Discover 和 Request 报文都是广播
> DHCP Offer 和 Ack 报文都是单播

### 发现 DHCP 服务器

客户端启动后，会向网络广播一个 DHCP Discover 报文，寻找 DHCP 服务器。此时由于客户端不知道服务器的地址，所以要发送广播。本地网络中的每个主机都会收到，但是只有 DHCP 服务才会响应。

报文如下：

![dhcp-discove]({{site.baseurl}}/assets/img/dhcp-discover.png)


### 提供 IP 租用地址

DHCP 服务器收到 DHCP Discover 报文后，从还没出租的地址范围内，选择最前面的空白 IP 地址，向客户端发送 DHCP Offer 报文。
报文如下：

![dhcp-offe]({{site.baseurl}}/assets/img/dhcp-offer.png)



### 接收租用并确认

客户端可能会收到一个或多个 DHCP Offer 报文（可能存在多个 DHCP 服务器），客户端从中选择一个 DHCP 服务器，并广播 DHCP Request 报文。**在报文中必须指明选择的服务器**
报文如下：

![dhcp-request]({{site.baseurl}}/assets/img/dhcp-request.png)

### 确认租约

被选中的服务情收到 DHCP Request 后，回应 DHCP Ack 报文，地址分配完成
报文如下：

![dhcp-ack]({{site.baseurl}}/assets/img/dhcp-ack.png)





