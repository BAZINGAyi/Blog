---
layout: post
tags: [network] # add tag
img: internet.jpg
---

# 路由器

路由器是网络互联的核心设备，它连接不同的网络，在网络之间转发 IP 数据报

---

## 路由表

路由表中记录了从如何达到其他网络的信息。每条路由表主要由三部分组成：目的网络、子网掩码和下一站（路由器的端口 ip，也就是网关）

---

# 静态路由

> 写完立即生效
> 手工配

当网络管理员配置了路由器的 IP 地址、子网掩码，启动接口后，路由表中就会出现直连网络的路由


## 静态路由配置

> 1. 统计网络个数
> 2. 每个路由器需要配置的路由数目等于总的网络数目减去本身连接的网络数目
> 3. 配置静态路由的目的网络直接添加需要去的网络
> 4. 配置静态路由的子网掩码是需要去的网络的子网掩码
> 5. 配置静态路由的下一跳为直接相连的路由器的端口地址

![route_mode]({{site.baseurl}}/assets/img/route_model.png)


```
// R3 预配置命令
enable 
configure terminal
line console 0
no exec-timeout
logging synchronous
no ip domain lookup

// hostname R3
interface ethernet 0/0
ip address 12.1.1.1 255.255.255.0
no shutdown
exit
interface loopback 0
ip address 1.1.1.1 255.255.255.0
no shutdown
exit
// 边界配置默认路由比较省时间
ip route 0.0.0.0 0.0.0.0 12.1.1.2

// hostname R4
interface ethernet 0/0
ip address 12.1.1.2 255.255.255.0
no shutdown
exit
interface loopback 0
ip address 2.2.2.2 255.255.255.0
no shutdown
exit
interface ethernet 0/1
ip address 23.1.1.1 255.255.255.0
no shutdown
exit
// 边界配置默认路由比较省时间
ip route 1.1.1.1 255.255.255.0 12.1.1.1
ip route 3.3.3.3 255.255.255.0 23.1.1.2
```

---

## 静态路由的选择路径选择规则：

mask 匹配最长掩码

最长掩码一样，比较 AD

AD 一样，比较 metric

全都一样负载均摊

---

# 动态路由

路由器之间可以通过路由协议，自主学习来获得的路由信息，这样的路由称为动态路由。使用路由协议动态构建路由表不需要人工参与，并能自动的适应网络状态的变化更新路由表，大型网络或状态变化频繁的网络通常会采用动态路由协议

## 自制系统和分层路由

因特网的网络数量巨大，几百万个路由器相互相互连接在一起。要让一个路由器记录每个网络的信息是不可能的，而且许多机构并不愿意自己的网络内部细节对外暴露

基于以上的原因因特网划分了许多个自制系统（Autonomous System）

自治系统内部的路由通过内部网关协议（IGP）交换路由信息，典型的内部网关协议有 RIP 和 OSPF

自治系统之间也需要交换路由信息，自治系统之间使用外部网关协议（EGP）交换路由信息，每个自治系统都会有边界路由器来完成这个任务，目前因特网使用的外部网关协议是 BGP

![classify-router]({{site.baseurl}}/assets/img/classify.jpg)

---

## RIP (距离矢量)

> 一般没有人用
> 应用层协议，使用 UDP 传输，端口为 520

路由信息协议（RIP）是路由器生产厂商之间使用的第一个开放标准，是连接不同厂商设备使用最为广泛的共有协议。RIP 协议有两个版本，V2 版本比 V1 版本的基础上增加了一些拓展特性，如更新认证、路由汇总、无类路由、VLSM 等

RIP 协议是基于矢量的路由状态协议。RIP 协议中，如果路由器 A 和 网络 B 直接相连，那么路由器 A 到网络 B 的距离就是 N + 1。如果从路由器 A 出发 到达网络 B 需要经过 N 个路由器，则路由器 A 到网络 B 的距离就是 N + 1。RIP 认为距离最小的路径就是最好的路径。RIP 中的距离也称为 “跳数”，每增加一个路由器，跳数就加 1。RIP 协议允许一条路径上最多包含 15 个路由器，距离的最大值为 16（表示网络不可达）

## 特性

> 由于路由器可能会收到它自己发送的路由信息，而这种信息是无用的，所以要采用一种状况避免这种情况的发生

水平分割：路由器从某个接口接收到的更新信息不允许再从这个接口发回去

毒性反转：实际上是一种改进的水平分割，当路由器从某个接口上接收到某个网段的路由信息后，并不是部往回发送信息了，而是将这个网段的跳数（距离）设为无限大，再发送出去。收到此种的路由信息后，接收方路由会立即抛弃该路由，而不是等到其老化时间到

## RIP 工作原理

1. 每个路由器每隔 30s 给自己所有的邻居路由器广播 RIP 报文，报文的内容是这个路由器当前的路由信息。当两个路由器共享一条链路或者在同一个物理网络中，就称它们为邻居
2. 收到邻居路由器的路由表信息后，更新自己的路由表，下次将更新后的路由表告诉自己的邻居
3. 180s 没有收到某个路由器的路由表信息，就认为这个路由器出现故障，路由表中将所有以这个路由器为下一站的表项的距离修改为 16，表示不可达。再过 60s 依然没有回复，从路由表删除

## 配置

![rip-router]({{site.baseurl}}/assets/img/026%7B58ODO3UX@J@%5BK7V%60CE2.png)


```
// 三台路由器正常配置端口

// R1 注意精确宣告
r1(config)#router rip r1(config-router)#no auto-summaryr1(config-router)#version 2r1(config-router)#network 12.1.1.1r1(config-router)#network 1.1.1.1r1(config-router)#network 13.1.1.1

// R2,R3 同理

// 排错命令
show ip rip database
show ip  protocols／ inc second
```


利用关闭水平分割，造成成环现象

```
//  关闭 R1 e 0/0 接口的水平分割
R1(config-if)#no ip split-horizon
//  关闭 R2 e 0/0 接口的水平分割
R2(config-if)#no ip split-horizon

//  设置 R2 的 e0/0 为被动，禁止发送协议报文
R2(config-router)#passive-interface e 0/0
//  关闭 R2 的 loopback 0 口
//  设置 R2 的 e0/0 为主动
R2(config-router)#no passive-interface e 0/0
```

这时我们可以利用 `show ip route` 来观察，会发现 R1 和 R2 的跳数一直都会增加，增加到 16，全都消失

原因：由于把 R2 的端口设置成被动，R1 收不到 R2 关闭了 lo 0 的消息。而且 R1，R2 的水平分割都已经被关闭。这时 R2 会收到来自 R1 的它到 2.2.2.0 网络的跳数是 1，所以你到 2.2.2.0 网络的跳数是 2。由于 R2 已经无法通过直连到达 2.2.2.2。所以会更新自己的跳数。之后 R2 又会给 R1 发送到 2.2.2.2 的跳数是 2。由于 R1 本身到 2.2.2.2 网络就是通过 R2，所以会更新自己的路由表跳数为 3。就这样以此类推直到到 16 结束




