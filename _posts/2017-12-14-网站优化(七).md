---
layout: post
tags: [web] # add tag
img: luca-bravo-217276-min.jpg
---

[TOC]


# Pipeline - Painting 的优化

Pipeline 中的 Paint 操作是引发页面性能的最大问题，通过 Chrome 中 Rendering 和 Performance ，可以帮助我们来查看当前页面 Painting 绘制的情况。

这里给出 [DEMO](https://www.html5rocks.com/static/demos/parallax/demo-1a/demo.html) 网站，用于展示各部分中的内容：

**选中Rendering 中的 show Paint rectangle 复选框，滚动页面，出现绿色的部表示正在被绘制的区域**


**在 Frame 条目中，选择 Layers，查看当前帧被绘制层次结构**

![Painting1](/assets/img/15141713561405.jpg)

![Painting2](/assets/img/15141714425692.jpg)

在 Main 条目中，找到 Paint 框，可以看到生成了一个新的 Timeline 区域，通过它，可以看到页面被完整绘制的过程。

由于我们选中了 paint 选项，这里出现的黑色背景的图片，表示它正在被绘制。
---

# Pipeline - Compositing 优化

## 图层合成过程的分析

通过 chrome 工具，我们可以看到有两个操作分别与合成图层相关，第一个是 `Update Layer Tree`, 它发生在 chrome 的内部引擎计算哪个图层需要出现在当前的页面上，它会查看元素的样式和计算所有元素的顺序和需要图层的数量。

第二个操作则是 `Composite Layers`，将所有的图层合成到一起然后发送到屏幕上。
![compositing](/assets/img/15133073707307.jpg)

有时为了减少 painting 的时间，我们去选择增加图层，但是图层越多，图层管理和花费的时间就会越多。这就意味着，我们需要在 pating 和 Compositing 之间做到一定的平衡。

---
 
## 利用 chrome 分析页面的图层
 
 ![Devtools](/assets/img/15133080932530.jpg)

 通过 `option command i` 打开 Devtools，选择 Rendering 选项打开 Layer borders 选择框。

![example](/assets/img/15133081521926.jpg)

这时的页面上显示了相应的图层：

淡颜色的方块是浏览器奖每个图层拆分成图块的一种方式，我们是无法控制这样的图层的。

橘红色的方块是表示的元素是位于自己的合成图层上，这样的图层就是我们所能控制的。

点击录制中的任意一帧后，我们可以通过 `Layer` 来了解当前页面的绘制情况。

---

## 创建图层

在 Chrome 和 Firefox 中：

```css
.circle {
    will-change: transform;
}
```

对于旧版浏览器和 Safari 中：

```
.circle {
    transform: translateZ(0);
}
```

将元素放进独立的图层汇总非常有助于避免绘制问题，特别适合在有动作或透明度相关的改变上应用。

当需要注意的是图层管理和渲染层合成不是独立分开的，需要在二者之间找到平衡点。







