---
layout: post
tags: [network] # add tag
img: internet.jpg
---

# 同网段的数据通信

![experience]({{site.baseurl}}/assets/img/experience.png)

> 把路由器的路由功能关闭，这里的 R1 代表的就是 PC 了，否则是 Ping 不通的

> 这里出现的设备均是第一次启动

> 利用交换机和 ARP 知识内容，如果不清楚，请移步上篇文章

使用 `ping` 命令进行测试

这里 R1 想要给 PC 发送 **IP 数据包**，只有按照要求封装成 2 层数据帧的格式才可以。这时发现目前有源 MAC 地址，却没有目的 MAC 地址，那么封包不成功，暂时将包搁置。接着发送 ARP 广播（将 ARP 广播添加帧头部发送,帧结构如下图）

![同网段通信]({{site.baseurl}}/assets/img/J%5B%25%7D9JNPI%60HUMWJ7%7DVWSHAJ%202.png)

交换机收到该数据包后发现目的 MAC 为 ffff:ffff:ffff, 根据交换机的转发规则，先将 R1 的源 MAC 和自己端口号（e0/0）存入 MAC 表，然后进行泛洪操作，广播到该网络的每一个主机。每个主机收到后开始解封装，进而查看到 ARP 报文中的目的 IP，PC 发现 目的 IP 和自己的 IP 一致，接着发送 ARP 响应报文（如下图）

![ARP响应报文]({{site.baseurl}}/assets/img/%7D9$VB%7DKPI1C@3H%7B5%5D1%5BW-%7BS.png)

交换机收到 PC 的 ARP 应答报文后，由于要去的 MAC 地址自己本身的 MAC 表里已经存在，进而直接转发给 R1。R1 收到 PC 的响应报文后，开始解封装，并查看 ARP 报文中的目的 MAC，添加到搁置的缺少目的 MAC 的数据包，接着将封装好的数据帧发送到 PC (ping 命令 在传输层是 ICMP 协议)

![ICMP]({{site.baseurl}}/assets/img/ICMP.png)

---

# 不同网段之间的通信

![ARP-OVER-Internet]({{site.baseurl}}/assets/img/ARP-OVER-Internet.png)

刚开始和上面一样由于 PC1 没有 PC2 的 MAC 地址，所以无法封包，进而进行 ARP 广播，**但这里需要强调的是，由于已经垮网段了，广播的消息只能在同一网段内传播，所以把广播交给路由器 R1，由路由器进行转发**，先看一下 ARP 广播，如下：

![PC1-ARP-Request]({{site.baseurl}}/assets/img/PC1-ARP-Request.png)

路由器 R2， 进行转发，需要注意的是，这里传递的数据帧的源 MAC 和 目的 MAC 已经发生改变，但是 ARP 协议中的内容并没有改变，如下：

![R1-ARP-Request]({{site.baseurl}}/assets/img/R1-ARP-Request.png)

这时交换机 Switch 收到目的 MAC，为全 F 的广播帧，记录 R2 E0/1 的MAC 地址后，进行泛洪，转发给 23.1.1.0 网段。PC2 把交换机发生过来的数据帧解析后，发现目的 IP 为自己的 IP，进而进行 ARP 应答（这里的目的 MAC 地址填的是**路由器的地址**，而 ARP 协议中的 Sender MAC 才是 PC1 的目的 MAC），交换机**直接**转发该报文给路由器（因为这时交换机的 MAC 地址表中已经有路由器的信息），路由器查看报文内容，报文如下：

![PC2-request-reponse]({{site.baseurl}}/assets/img/PC2-request-reponse.png)


路由器解析报文后，将 ARP 协议取出，封装给新的数据帧发送给 PC1，ARP 应答包如下：

![router-request]({{site.baseurl}}/assets/img/router-request.png)


PC1 收到路由器发来的 ARP 应答包后，解封装，取出 PC2 的目的 MAC 地址，添加到自己搁置的数据包中，形成新的数据帧发送给 PC2，报文如下：

![frame]({{site.baseurl}}/assets/img/frame.png)

> 同网段和不同网段的通信过程，有问题欢迎指出

----

# 配置 VLAN

> Vlan 翻译成中文，是"虚拟局域网"。 LAN 可以是由少数几家用计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN 所指的 LAN 特指使用路由器分割的网络，也就是广播域。

> 二层交换机只能构建单一的广播域，不过使用 VLAN 功能后，能够将网络分割成多个广播域。

> VLAN TAG 包的 VLAN ID 号，有效范围是 1-4094，0 和 4095 都为协议保留值，VLAN ID 0 表示不属于任何VLAN，但携带 802.1Q 的优先级标签，所以一般被称为Priority-only frame，其一般作为系统使用，用户不可使用和删除。1 为系统默认 VLAN，即 Native VLAN，2-1001 是普通的 vlan，1006-1024 保留仅系统使用，用户不能查看和使用，1002-1005是支持 fddi 和令牌环的 vlan，1025-4095 是扩展的 vlan。

![VLAN]({{site.baseurl}}/assets/img/VLAN.png)

---

## 通信过程

假设所有交换机都刚开机，PC 发出一个数据包经过交换机 SW1，交换机会按照 端口的 PVID 打上 10 的 TAG 标记，然后交换机会把这个数据帧转发给 VID = 10 的所有端口（除了进口），如下：

![tag]({{site.baseurl}}/assets/img/tag.png)

由于 SW1 的 Trunk 口拥有 VID = 10，进而接受 Tag ，并进行转发，数据帧到达 SW3 后，e0/2 和 e 0/3 均为 trunk 口，发现可接受 TAG 为 10 的 tagged 数据帧，直接进行转发，如下

![trunk]({{site.baseurl}}/assets/img/trunk.png)

SW2 的 trunk 口，e 0/3 同样也能接受 VID = 10 的数据。并且在 e 0/0 的 access 口进行 untag。而 e 0/1 的 access 只能接受 vid = 20 的数据，所以不能进行转发。如下：

![untag]({{site.baseurl}}/assets/img/untag.png)

这样 PC3 就正常接收到 PC1 的数据了

---

## 配置过程

```
PC1、PC2、PC3、PC4 配置 IP

Sw1：
sw1(cinfig)# vlan 10
sw1(cinfig)# vlan 20
sw1(config)# int e0/0sw1(config-if)# switchport mode access sw1(config-if)# switchport access vlan 10
sw1(config-if)# exit
sw1(config-if)# switchport mode access sw1(config-if)# switchport access vlan 10
sw1(config-if)# exit
sw1(config)#int e0/2sw1(config-if)# switchport trunk encapsulation dot1q sw1(config-if)# switchport mode trunk

sw1# show vlan brief 
sw1# show interfaces trunk

Sw3:
sw3(config)# vlan 10
sw3(config)# vlan 20
sw3(config)# int range e0/2-3sw3(config-if-range)# switchport trunk encapsulation dot1qsw3(config-if-range)# switchport mode trunk
```





