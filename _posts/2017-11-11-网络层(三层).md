---
layout: post
tags: [network] # add tag
img: internet.jpg
---

# IP 协议

## IP 协议内容

> IP 协议封装 TCP 或 UDP 数据报，形成 IP 数据报

![IP 协议]({{site.baseurl}}/assets/img/15105483341013.jpg)

---

## IP 地址

> 一个网络接口，一个 IP 地址


> 公有地址是运营商拥有的IP地址。
私有地址是不属于公有地址的，除本机环回口地址外的地址。
私有地址不可以访问公有地址。

### 分类

> 分为网络位和主机位

#### A 类

| 0xxxxxxx | xxxxxxxx | xxxxxxxx | xxxxxxxx |
| --- | --- | --- | --- |
| 网络位 | 主机位 | 主机位 | 主机位 |

#### B 类

| 10xxxxxx | xxxxxxxx | xxxxxxxx | xxxxxxxx |
| --- | --- | --- | --- |
| 网络位 | 网络位 | 主机位 | 主机位 |

#### C 类

| 110xxxxx | xxxxxxxx | xxxxxxxx | xxxxxxxx |
| --- | --- | --- | --- |
| 网络位 | 网络位 | 网络位 | 主机位 |

---

## 特殊 IP 地址

### 全 0 或 全 1 地址

| 网络号 | 主机号 | 含义 |
| --- | --- | --- |
| 全 0  | 主机号 ID | 本网络上的某个主机 |
| 网络号 ID | 全 1 | 某个网络的网络号 |
| 网络号 ID | 全 0 | 某个网络的网络号 |
| 全 1 | 全 1 | 本地网络的广播地址 |
| 全 0 | 全 0 | 本网络上的某个主机  |

### 私有地址

> 不需要申请直接使用

10.0.0.0 ~ 10.255.255.255

172.16.0.0 ~ 172.31.255.255

192.168.0.0 ~ 192.168.255.255

---

## 子网掩码

子网掩码是一个 32 比特的数字，与 IP 地址一一对应，用来标识 IP 地址中哪些是网络位，哪些是主机位

具体的方法是：子网掩码中的 1 对应 IP 地址中的**网络号和子网号**，子网掩码中的 0 对应 IP 地址中的主机号

--- 

## 子网划分

> 根据主机位去划分，找需要最多网络的主机数

### 例一： 某公司有四个部门，分别是 A，B，C，D，每个部门需要 20 个 IP 地址，该公司申请了一个 C 类地址块， 192.168.1.0/24，请给出合理的子网划分方案
```

按照主机位数划分：一共四个部分，每个部分最多 20 台主机

2^n - 2 >= 20, n = 5

原来的主机位为 8 位，改变后的网络只需要 5 位，所以剩下的 3 位为子网络位,划分后的 8 个网络为：


11000000.10101000.00000001.000|00000：192.168.1.0/27
11000000.10101000.00000001.001|00000：192.168.1.32/2711000000.10101000.00000001.010|00000：192.168.1.64/2711000000.10101000.00000001.011|00000：192.168.1.96/2711000000.10101000.00000001.100|00000：192.168.1.128/2711000000.10101000.00000001.101|00000：192.168.1.160/2711000000.10101000.00000001.110|00000：192.168.1.192/2711000000.10101000.00000001.111|00000：192.168.1.224/27

对于第一个网络来说：
网络地址为： 192.168.1.0/27
可用地址为： 192.168.1.1／27 ～ 192.168.1.30／27
广播地址为： 192.168.1.31/27
```

---

### 例二：某公司，A,B,C,D 四个部门，A 部门需要 100 个 IP 地址，B 部门需要 50 个 IP 地址，C 和 D 部门需要 25 个 IP 地址，现在公司申请了一个 C 类地址块，192.168.2.0/24.请给出合理的子网划分方案？

C 类地址一共能划分 126 主机 > 100 + 50 + 25 + 25, 可以划分

原网络如下：


192.168.2.0/24
11000000.10101000.00000010.00000000
11111111.11111111.11111111.00000000


第一次划分：
根据主机数量进行划分：A 需要 100 个 IP，2^n-2>100 ，n=7，划分后的网络如下：

11000000.10101000.00000010.0|0000000
11111111.11111111.11111111.1|0000000

剩下一个主机位，使该主机位成为新的子网络位

11000000.10101000.00000010.0|0000000：192.168.2.0/25 
11000000.10101000.00000010.1|0000000：192.168.2.128/25 

拿出第一个网络分给 A，剩下的网络 192.168.2.128/25，继续分配

第二次划分：
B 需要 50 个网络，2^n-2>50 ，n=6，划分后的网络如下：

11000000.10101000.00000010.10|000000
11111111.11111111.11111111.11|000000

又剩下一个主机位，使该主机位成为新的子网络位

11000000.10101000.00000010.10|000000：192.168.2.128/26
11000000.10101000.00000010.11|000000：192.168.2.192/26

拿出第一个网络分给 B，剩下的网络 192.168.2.192/26
，继续分配

第三次划分：
B 需要 25 个网络，2^n-2>25 ，n=5，划分后的网络如下：

11000000.10101000.00000010.110|00000
11000000.10101000.00000010.111|00000

又剩下一个主机位，使该主机位成为新的子网络位

11000000.10101000.00000010.110|00000：192.168.2.192/27
11000000.10101000.00000010.111|00000：192.168.2.224/27

将剩下的两个网络分给 C 和 D

---

### 例三：跨网段的划分

![子网划分]({{site.baseurl}}/assets/img/15105534808200.jpg)

```

首先确定共需要 8 个网络。每台路由器之间为一个网络（主机数为 2），共 4 个。右边的路由器单独又有一个网络，主机数为 50

然后根据主机数量划分，50 个 IP 地址，2^n-2>50 ，n=6。需要的网络主机位为 6

待划分的网络为：

172.16.32.0/20
10101100.00010000.0010|0000.00000000
11111111.11111111.1111|0000.00000000

由于需要 6 个主机位，所以从原网络中的 12 个主机位中使用 6 个当主机位，剩下的 6 个位置位网络位
10101100.00010000.00100000.00|000000
11111111.11111111.11111111.11|000000

划分后的新网络为：
10101100.00010000.00100000.00|000000：172.16.32.0/26
10101100.00010000.00100000.01|000000：172.16.32.64/26 
10101100.00010000.00100000.10|000000：172.16.32.128/26
10101100.00010000.00100000.11|000000：172.16.32.192/26
10101100.00010000.00100001.00|000000：172.16.33.0/26
10101100.00010000.00100001.01|000000：172.16.33.64/26
10101100.00010000.00100001.10|000000：172.16.33.128/26
.....................................................
.....................................................
10101100.00010000.00101111.11|000000：172.16.47.192/26

划分后的网络总数为 2^6 = 64 个网络，每个网络中有 2^6 -2 = 62 个IP

然后从 64 个网络中拿出 4 个给需要 50 台主机的网络，然后再拿出一个网络需要 2 个主机 的 4 个网络

从 64 个网络中拿出一个网络：
10101100.00010000.00100001.00|000000:172.16.33.0/26
该网络有 6 个主机位，而现在每个网络中需要 2 个主机位，2^n-2>=2 ，n=2 所以主机位为 2，新的子网络位为 4

再次划分出的网络为：
10101100.00010000.00100001.000000|00：172.16.33.0/30 
10101100.00010000.00100001.000001|00：172.16.33.4/30 
10101100.00010000.00100001.000010|00：172.16.33.8/30 
10101100.00010000.00100001.000011|00：172.16.33.12/30 
10101100.00010000.00100001.000100|00：172.16.33.16/30
.....................................................
.....................................................
10101100.00010000.00100001.001111|00：172.16.33.60/30

共需要 4 个网络，从划分从 16 个网络中取出 4 个

最后余下 59 个 网络，每个网络中有 62 可用的 IP
和 12 个网络，每个网络中有 2 个可用的 IP

```

---

# ICMP 协议

IP 提供一种无连接的、尽力而为的服务，不存在关于网络连接的建立和维护过程，也就不包括流量控制与差错控制能力。因此在 IP 数据报的传输过程中，出现各种的错误是在所难免的，为了通知源主机 IP 数据报传输过程中遇到的问题，因此设计类因特网控制报文协议(ICMP)


## 分类

### 查询报文

产生途径：

1. ping 查询
2. 子网掩码查询
3. 时间戳查询 

### 差错报文

差错报文产生在发送错误的时候

> 下列情况不会产生差错报文
> 差错报文不会产生差错报文(防止 ICMP 无线产生和传送)
> 目的地址是广播或多播的 IP 数据报
> 作为链路层广播的数据报
> 不是 IP 分片的第一片
> 源地址不是某个主机的数据报



## 使用 Traceroute 来测量主机和目的主机的路由状况

> TTL：当 IP 数据包进行传送时，每经过一个路由器，TTL 指就会减一，当 TTL = 0 时，该 IP 数据报会被丢弃。

### Traceroute 原理

![route_mode]({{site.baseurl}}/assets/img/route_model-1.png)



当主机收到目的主机的 IP 后，会给目的主机发送一个 TTL = 1 的 UDP 数据包。如下
![TTL=1]({{site.baseurl}}/assets/img/TTL=1.png)



而经过第一个路由器后，TTL - 1 变成 0.这时路由器会把数据报丢弃，然后把丢弃的数据包的 IP 头部封装起来，回复主机一个差错报文。如下：

![response]({{site.baseurl}}/assets/img/response.png)


这个过程主机会发三次，也就是说会产生 3 个 TTL =1 的 UDP，如下

![TTL=1_three]({{site.baseurl}}/assets/img/TTL=1_three.png)

接着会在再次发送 3 个 TTL = 2 的 UDP 报文，如下

![TTL=2]({{site.baseurl}}/assets/img/TTL=2.png)

第二个路由器，会再次向主机发送一个差错报文，如下：

![TTL=2_response]({{site.baseurl}}/assets/img/TTL=2_response.png)

由于图中只经过 2 个路由器，所以截止发送到 TTL = 2

![TTL=2_three]({{site.baseurl}}/assets/img/TTL=2_three.png)


**并且我们可以从 TTL = 2 的回复差错报文看出，只有两个差错报文。其中有个差错报文出现了丢失，并且没有给主机回复差错报文丢失的情况**

 


