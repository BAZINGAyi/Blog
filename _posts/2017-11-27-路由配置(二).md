---
layout: post
tags: [network] # add tag
img: internet.jpg
---

# 动态路由

**发现远端网络**
路由器可以直接获得直连路由，这是由路由器的接口 IP 地址得到。动态路由能够自动学习远端目的路由条目

**维护和更新路由信息**
路由信息保存在路由器的路由表中。但路由的情况有时会发生变动。动态路由支持自动更新这些变化

**在多个到达目的网络的路径之中选择最优路径**
有时，路由协议会计算出到达同一目的网络的多条可用路径，路由协议需要有办法在多条路径之中选出最优的一条用于转发数据。

**在当前路径不可用发现一条新的可行路径的能力**
我们给这种过程（网络发生变化后，路由协议重新对路由进行计算并与其它路由器交换路由信息）起了一个名字，叫收敛。收敛的最终结果是网络重新回到一个稳定的正确的工作状态，我们给这种状态也起了一个名字叫收敛。收敛的速度越快越好，是体现路由协议性能的重要指标。


## EIGRP

思科私有协议，之后公开。之前因为是私有协议，导致的兼容性问题，没发展起来

### EIGRP 特性

EIGRP 收敛速度快，依靠 DUAL 算法，EIGRP 能够做到比链路状态路由协议还要迅速的收敛，快速的响应拓扑变更。

EIGRP 默认支持等价负载均衡，除此之外，目前只有 EIGRP 能够支持非等价的负载均衡。

EIGRP 通过 DUAL 算法，可以保障形成一个绝对无环的拓扑。

EIGRP 是一个无类路由协议，而它的前身 IGRP 是一个有类路由协议，EIGRP 使用组播更新，保留的组播地址为 224.0.0.10。

> 有类指的是 比如 A，B ，C 这样的网络
> 无类指的是支持子网划分

EIGRP 使用触发更新加增量更新，只在邻居刚刚建立时发送一次完整更新，之后只发送更新的内容

### EIGRP 数据结构

路由表

拓扑表

邻居表
> Hello 报文，包很小

### EIGRP 常用概念

S:后继路由器
满足 FC，且 CD 最小的路由

FS：可行后继路由器
满足 FC，但 CD 比 S 要大的路由

AD(RD)：通告距离/报告距离
上游路由器通告给本地路由器，到达一个目标网络的距离

FD：可行距离
进入被动状态后，路由曾经拥有过的最小距离

CD：计算距离
本地路由器到达一个上游邻居的距离加上该上游邻居的 AD

FC（可行性条件）（防环）
FC 是 EIGRP 防止环路的重要参数，该条件为如果一条路由想要成为 FS，它的 AD 必须小于当前 FD。由于产生环路时，数据一定是经过了一定的路由器后又回到了某台路由器，这时，该路由累加的开销，一定会大于当前从这台路由器到达目的网络的开销。

图解：

![eigrp-example]({{site.baseurl}}/assets/img/15117735132410.jpg)


首先默认 metric 为图中的固定值，并且路由器刚启动 FD 默认为无穷大

以 R1 为视角，从 1.0 到 2.0 网络的过程

| router | RD | CD |
| --- | --- | --- |
| R2 | 30 | 60  |
| --- | --- | --- |
| R3 | 20 | 60  |
| --- | --- | --- |
| R4 | 15 | 35  |

CD 最小的是 R4 ，故 S 为 R4

由于 FD 无穷大 ，故 FS 为 R2，R3

此时 FD 为 35，同时发现 R3 的 RD 为 40，大于 FD 所以将 R3 到 2.0 网络的这条路刨除

但可以发现此时并没有构成环路，所以 EIGRP 在彻底消灭环路的同时也错误的隔离了一些正确的道路

S／FS（后继路由器/可行后继路由器）(快速收敛)

一旦 S 出现问题，FS 就会马上替代

> 特殊情况一旦 FS 也变空，会将 FD 设为无限大


### EIGRP 配置


```
// R1 
// 开启 EIGRP 进程1（注意，这个 1 是AS号，与 OSPF 不同，如果AS号不一致，EIGRP无法建立邻居关系）
R1(config)# router eigrp 1
R1(config-router)# network 14.1.1.1 0.0.0.0
R1(config-router)# network 15.1.1.1 0.0.0.0
R1(config-router)# network 13.1.1.1 0.0.0.0

// R2 ， R3 ，R4 ，R5 同理

// 排错命令
show ip route
// 查看有没有建立邻居关系
show ip eigrp neighbor
show ip protocol
// 查看 EIGRP 拓扑表的摘要信息
show ip eigrp topology
```
network x.x.x.x y.y.y.y
宣告 x.x.x.x 网络，y.y.y.y 为通配符掩码（反掩码）

network （宣告网络）
该命令共有两个作用。首先配置在该命令的参数，应该是一个有类网络（仅对于 RIP 而言）。如果有路由器的接口IP地址，属于 network 所宣告的网络，则该接口被宣告进RIP进程
1. 该接口所对应的直连网络，会随 RIP 路由更新发送给其它路由器
2. 该接口会开始发送和接收 RIP 报文

---

## OSPF 

开放是指 OSPF 是一种基于开放标准的路由选择协议，路径最短优先是指 OSPF 在路由选择上采用 Dijkstra 所提出的最短路径算法

OSPF 是基于链路状态的路由协议。（链路状态指这个路由器与哪些路由器相邻，以及它们之间链路的"度量"）。OSPF 使用带宽、延迟、负载、距离和费用等多种元素来考虑度量，度量越小，代价越小

每个使用 OSPF 的路由器中拥有整个拓扑，并且不传递路由，仅仅是发送链路状态通道 

OPSF 使用触发更新加增量更新。（OSPF 有一个非常缓慢的周期更新）

> 作为对比，RIP 使用周期更新加完整更新（RIP 也具有触发更新的机制）
> 触发更新：当拓扑发生变化时，立即发送更新。
> 周期更新：每经过一个时间周期，发送一次更新。
> 增量更新：只发送变化部分的路由信息。
> 完整更新：发送所有路由信息。


### 工作原理

每个路由器回周期性的向相邻路由器发送探测报文，检测其是否可达。如果邻站给予应答，说明链路正常；否则说明链路出现故障

如果一个路由器检测到某条链路状态协议发送变化，该路由器就发送链路状态更新报文，泛洪对全网更新链路状态
> 泛洪指某个路由器收到更新报文后都将这个报文发送给自己的相邻路由器，直到报文送到整个网络

即使链路状态没有发生变化，每隔 30min 路由器要向网络中的其他路由器广播链路状态信息，以保证链路状态数据库和全网保持一致

每个路由器收到其他路由器的链路状态信息后，更新链路状态数据库，构建整个网络的拓扑图，利用 Dijkstra 的最短路径算法计算出到达每个网络的最短路径

### 工作过程

链路状态路由协议的主要工作原理是通过让拓扑中的每台路由器都在整个拓扑的范围内泛洪自己的链路状态通告（LSA），每台路由器都会获得整个拓扑中其它所有路由器的 LSA。用这些 LSA 生成全拓扑统一的链路状态数据库（LSDB），再使用 SPF 算法计算出一个 SPF 树（每台路由器以自己为起点到达拓扑中所有子网的树形结构）。这个工作过程类似于拼图。每台路由器生成的 LSA 相当于一块地图的碎片，用可靠的机制泛洪这些地图碎片后，每个路由器都能获得一个整张拓扑的地图，这个地图就是 LSDB。

1. 发现邻居，建立并维护邻居关系
2. 生成LSA，每台路由器都会生成自己的LSA
3. 泛洪LSA，使用OPSF自身具备可靠传输能力将LSA泛洪到区域中的其它路由器上
4. 将收到的LSA组装成LSDB，根据SPF算法计算出到达拓扑中所有网络的最短路径
5. 将计算得出的路由装载到路由表

### 存在问题及解决方式

**问题**

OSPF 在很多方面有着很大的优势，但也存在着问题随着网络规模越大资源消耗呈指数增长，限制扩展性。

**解决方式**

OSPF使用两级区域划分，所有区域被分为普通区域和骨干区域。区域用一个 32bit 的数来进行标识。可以用点分十进制的方法，也可以直接用一个十进制数标识。唯一需要注意的，骨干区域区域号固定为0。骨干区域只有一个，且必须连续。

区域在进行规划的时候，一般要根据一个区域内路由器的型号，性能，以及负载来进行设计，通常一个区域中的路由器数量为30到100台左右。

区域在进行规划的时候，一定要注意，所有普通区域必须与骨干区域直接相连。该要求主要是为了 OSPF 区域间防环。

> 由于 SPF 算法本身可以保证 OSPF 在区域内部无环路，所以区域间防环主要依靠网络设计来解决。因为 OSPF 在区域间使用类似距离矢量路由协议的路由传递方式，所以不能保证没有环路，如果所有普通区域都直接连接到

进而将路由器分成了几类：
1. 区域内部路由器（所有的接口都位于同一区域）
2. 区域边界路由器（ABR）（有不同的接口位于不同的区域且其中一个为骨干区域）
3. 自治系统边界路由器（ASBR）（进行了重分布操作,将其它路由器源学习到的路由引入 OSPF 的路由器）

### OSPF 数据结构

邻居表

真拓扑表

路由表

### OSPF 建立邻居

Hello 报文，动态邻居发现，邻居参数协商，邻居关系保持。

动态邻居发现：OSPF 的邻居关系，在支持广播（支持组播）的链路上，可以自动建立，而不需要管理员进行显式配置。通过向组播地址（224.0.0.5）发送 OSPF Hello包，OSPF 能动态发现链路上的其它 OSPF 路由器

>224.0.0.6 DR OSPF路由器


#### 邻居协商参数

1. Router-ID，路由器标识符。两台路由器想建立 OSPF 邻居关系，Router-ID 必须不同。Router-ID 可以由管理员进行手工配置，一个点分十进制的 32bit 值。如果管理员没有显式配置 Router-ID，路由器获取自身最大的环回接口 IP 地址作为自己的 Router-ID，如果没有配置环回接口，则获取最大物理接口 IP 地址作为自己的 Router-ID。推荐对 Router-ID 进行手工配置。
2. Hello Interval&Dead Interval，Hello 计时器和死亡计时器。默认在高速链路上，为10秒40秒。当 Hello 计时器超时，路由器将发送Hello 报文，当死亡计时器超时，路由器将会断掉与该邻居的邻居关系。而每次从邻居收到 Hello 报文将重置死亡计时器。建立邻居关系的路由器要求拥有完全一致的 Hello 和 Dead  Interval。
3. Active Neighbors，活跃邻居，一个发送 Hello 报文路由器的邻居列表。
4. Area ID，区域号，代表该接口属于哪个 OSPF 区域。建立邻居关系的两个路由器（两个接口）必须属于同一个区域。
5. Router Priority:接口的优先级，影响 DR，BDR 选举。越大越好，默认为 1，最大为 255，当优先级为 0 时，代表不参与 DR,BDR 选举。
6. DR 指定路由器，BDR 备份指定路由器。在每个链路上通过选举产生，路由器优先级越大越好，当优先级都相等时，选举 Router-ID 最大的路由器。
7. Authentication Type&Date，认证类型与认证数据，认证类型指示邻居关系使用什么方式进行认证（空：不认证，明文认证，MD5 摘要认证），默认使用空认证且不携带认证数据。认证类型或认证数据不一致都会导致 OSPF 邻居建立失败。

8. Stub Area Flag  末节区域标记，建立邻居的路由器必须拥有完全一致的末节区域标记。

> 邻居与邻接
OSPF 邻居关系，分为邻接和邻居两种。LSA 只在邻接关系的邻居之间同步，普通邻居关系之间不同步 LSA 信息。事实上在一个多路访问链路上，所有的路由器都需要与 DR 路由器建立邻接关系，同时也要与 BDR 路由器建立邻接关系，DR Other 之间，只建立邻居关系，不会同步数据库信息。DR 和 BDR 机制就是依靠这种方式降低 OSPF 进程对路由器资源占用的。所有建立全互连的协议都存在 n 次方问题（假如 n 个路由器互相建立邻接关系，那么将需要建立 n（n-1）/2 个邻接关系。），所有路由器如果只与 DR 和 BDR 建立邻接关系，则只需要建立（n-1）+（n-2）个邻接关系。

#### OSPF状态机
Down   初始状态
与邻居之间的接口没有宣告 OPSF 进程。某些情况下也会让邻居处于 DOWN 的状态比如链路两端分别为点到点和点到多点网络类型

Init 初始化状态
发出，并收到一个 Hello 包，其中不包含自己的 Router-ID。会让自己处于初始化状态。如果链路存在单向链路问题，会让邻居关系保持在初始化的状态无法继续向前迁移。

Attempt（NBMA）尝试状态
每 poll 时间（120秒）向对面发送一个 Hello 包尝试建立一个邻居关系。只在低速的 NBMA 链路上出现

2-WAY  双向通信状态
收到邻居发来的 Hello 包，且其中包含自己的 router-id，则认为与邻居之间的双向通信已经建立，进入 2-WAY 状态。 2WAY 状态邻居两端需要进行如下操作：
先判断网络类型，是否需要选举 DR,BDR
如果不需要选举 DR,BDR，则直接转换到 EX-START。
如果是广播型或 NBMA 网络，则选举 DR,BDR。
判断邻居之间是否需要建立邻接关系。
这个是邻居路由器之间的稳定工作状态。
当 DR，BDR 选举结束，且邻居之间需要建立邻接关系，则继续想 ExStart状态迁移。


ExStart
该状态下路由器的主要任务是选举主从路由器主导 DBD 的交互。发送空的，标志位置位情况为 111 的 DBD 报文来进行主从选举。当从路由器发出标志位置位情况为 010 或 000 的报文后，则进入 Ex-Change 状态。
如果接口的 MTU 设置不一致，则邻居关系会停留在 ExStart 状态

ExChange 
通过发送 DBD 报文，同步数据库结构。
当主发出 001，从回复 000 报文的时候，DBD 报文交互结束。根据链路状态请求列表的情况，进入 Loading 或者 Full 状态。
Loading 继续发送 LSR，请求数据库中缺少的 LSA。同步数据库。
Full 数据库同步完成。一个邻接关系成功建立。Full 是邻接关系的稳定工作状态。 


> 在哪些情况下需要选举 DR，BDR?
> 根据链路类型进行选择 （点对点不选，以太网线选）

> 为什么要在多路访问网络当中选举 DR,BDR ？
为了减少邻接关系的数量，减少 LSA 的泛洪流量，减少 CPU 资源和链路带宽的占用。

> 如何选举 DR,BDR
根据接口优先级。优先级越大，越可能称为 DR。默认优先级为 1，优先级为 0 时，代表不参与选举。如果优先级相同，则比较 Router-ID 来进行选举，Router-ID 大的路由器，成为 DR



#### OSPF 邻居无法建立原因汇总

1. 邻居路由器发送的 HELLO 包中，Router-ID 字段相同
2. 邻居路由器发送的 HELLO 包中，Area-ID 与本端接口 Area 宣告不一致，邻居无法建立
3. 邻居两端认证类型不一致，邻居无法建立
4. 邻居两端认证数据不一致，邻居无法建立
5. 邻居两端接口掩码配置不一致，邻居无法建立
6. 邻居两端的 Hello-interval 配置必须一致，否则邻居无法建立
7. 邻居两端的 dead-interval 配置必须一致，否则邻居无法建立
8. 如果邻居两端末节区域标记不一致，则邻居无法建立

#### OSPF 报文类型

1. Hello 报文，用于 OSPF 邻居动态发现，邻居参数协商，邻居关系维护。
2. DBD 报文，用于传递 LSDB 摘要信息，实际上是 LSDB 中 所有 LSA 的头部信息。OSPF 路由器通过交换 DBD 报文，来统计自己缺少的 LSA 并向对端发送 LSR 报文进行请求。
3. LSR 报文，用于向邻居请求自己 LSDB 中没有的 LSA
4. LSU 报文，LSU 用于给邻居发送它们请求的 LSA，只有 LSU 报文中会包含完整的 LSA,注意 LSA 本身不是一种报文
5. LSAck 报文，LSAck 用于向邻居确认收到的 LSU，如果没收到 LSAck 的话，邻居会不断重传请求的 LSU。注意区分 LSA 和 LSAck


### OSPF 配置

![ospf-route]({{site.baseurl}}/assets/img/ospf-router.png)


```
//R1:
R1(config)# router ospf 1
R1(config-router)# router-id 12.1.1.1
R1(config-router)# network 12.1.1.1 0.0.0.0 area 1
R1(config-router)# network 1.1.1.1 0.0.0.0 area 1

//R2:
R2(config)# router ospf 1
R2(config-router)# router-id 23.1.1.1
R2(config-router)# network 12.1.1.2 0.0.0.0 area 1
R2(config-router)# network 23.1.1.1 0.0.0.0 area 0

//R3:
R2(config)# router ospf 1
R2(config-router)# router-id 34.1.1.1
R2(config-router)# network 34.1.1.1 0.0.0.0 area 2
R2(config-router)# network 23.1.1.2 0.0.0.0 area 0

//R4:
R4(config)# router ospf 1
R4(config-router)# router-id 23.1.1.1
R4(config-router)# network 12.1.1.3 0.0.0.0 area 2
R4(config-router)# network 2.2.2.2 0.0.0.0 area 2
```




